/** * <p>Title: WallServiceImpl.java</p> * <p>Description: </p> * <p>Copyright: Copyright (c) </p> * <p>Company: adwalker</p> * @author jiangwei * @date Aug 21, 2012 * @version 1.0 */package cn.adwalker.ad.admin.task.service.impl;import java.util.Date;import java.util.List;import javax.annotation.Resource;import org.apache.log4j.Logger;import org.springframework.stereotype.Service;import cn.adwalker.model.app.dao.IDeveloperDao;import cn.adwalker.ad.admin.task.service.IApiFinanceTaskService;import cn.adwalker.ad.admin.task.vo.ApiFinanceVo;import cn.adwalker.ad.api.app.util.ApiUtils;import cn.adwalker.ad.api.app.util.Crypts;import cn.adwalker.ad.api.app.vo.DevIncome;import cn.adwalker.core.util.DateUtil;import cn.adwalker.core.util.JacksonMapper;/** * <p> * Title: WallServiceImpl * </p> * <p> * Description: * </p> * <p> * Company: adwalker * </p> *  * @author jiangwei * @date Aug 21, 2012 */@Servicepublic class ApiFinanceTaskServiceImpl implements IApiFinanceTaskService {	private static Logger logger = Logger			.getLogger(ApiFinanceTaskServiceImpl.class);	@Resource	private IDeveloperDao developerDao;	/**	 * (non-Javadoc)	 * <p>	 * Title: doTask	 * </p>	 * <p>	 * Description:TODO	 * </p>	 * 	 * @param date	 * @throws Exception	 * @see cn.adwalker.ad.admin.task.service.IApiFinanceTaskService#doTask(java.util.Date)	 */	@SuppressWarnings("unchecked")	@Override	public void doTask(Date date) throws Exception {		if (date != null) {			// 查询当天有新收入确认的开发者			List<ApiFinanceVo> list = (List<ApiFinanceVo>) developerDao					.findAll(							"SELECT DISTINCT dev.id as dev_id  FROM  T_FINACE_DEV_INCOM_CONFIRM ic  LEFT  JOIN   T_APPLICATION  app   on ic.app_id=app.id LEFT  JOIN  T_DEVELOPER  dev on app.dev_id=dev.id where ic.FINANCE_TIME=?  and dev.resource_code=?",							new Object[] { DateUtil.formatDate(date), "KUAIYOU" },							ApiFinanceVo.class);			if (list != null && list.size() > 0) {				StringBuilder sb = new StringBuilder();				for (ApiFinanceVo vo : list) {					sb.append(vo.getDev_id()).append(",");				}				sb.deleteCharAt(sb.length() - 1);				List<DevIncome> devIncomes = (List<DevIncome>) developerDao						.findAll(								"SELECT id as  dev_id,confirmed_total,IFNULL(freeze_money,0) freeze_money from  T_DEVELOPER where id in ("										+ sb.toString() + ")", DevIncome.class);				ApiUtils.sendFinnanceMony(Crypts.xorMapEncrypt(Crypts.key,						JacksonMapper.objectToJsonString(devIncomes)));				logger.debug("发送开发者收入数据!!");				System.out						.println(JacksonMapper.objectToJsonString(devIncomes));			}		}	}}