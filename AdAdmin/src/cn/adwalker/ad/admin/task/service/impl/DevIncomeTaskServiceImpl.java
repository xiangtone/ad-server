/** * <p>Title: WallServiceImpl.java</p> * <p>Description: </p> * <p>Copyright: Copyright (c) </p> * <p>Company: adwalker</p> * @author jiangwei * @date Aug 21, 2012 * @version 1.0 */package cn.adwalker.ad.admin.task.service.impl;import java.util.ArrayList;import java.util.Date;import java.util.List;import javax.annotation.Resource;import org.apache.log4j.Logger;import org.springframework.stereotype.Service;import cn.adwalker.model.operation.dao.IOperationDevIncomeAuditDao;import cn.adwalker.ad.admin.task.service.IDevIncomeTaskService;import cn.adwalker.ad.admin.task.vo.EffectVo;import cn.adwalker.core.util.DateUtil;/** * <p> * Title: WallServiceImpl * </p> * <p> * Description: * </p> * <p> * Company: adwalker * </p> *  * @author jiangwei * @date Aug 21, 2012 */@Service("devIncomeService")public class DevIncomeTaskServiceImpl implements IDevIncomeTaskService {	private static Logger logger = Logger			.getLogger(DevIncomeTaskServiceImpl.class);	@Resource	private IOperationDevIncomeAuditDao devIncomeAuditDao;	/**	 * (non-Javadoc)	 * <p>	 * Title: tranceDevIncome	 * </p>	 * <p>	 * Description:TODO	 * </p>	 * 	 * @param date	 * @return	 * @throws Exception	 * @see cn.adwalker.admin.task.service.IDevIncomeTaskService.dev.service.IDevIncomeService#tranceDevIncome(java.util.Date)	 */	@Override	public void tranceDevIncome(Date date) throws Exception {		logger.debug("DevIncomeTask.....run");		if (date != null) {			if (date != null) {				// 1、当天内根据应用、广告（带形式的(⊙o⊙)哦）分组				// 2、取出成本金额、效果数据				// 3、对现有数据进行merge操作，如果存在更新判断状态，是否已经确认，如果没确认，更新数据，已经确认原值不变。				StringBuilder sb = new StringBuilder();				sb.append(" INSERT INTO T_FINACE_DEV_INCOM_CONFIRM(APP_ID,ad_id,DEV_COST,EFFECT_TIME,CREATE_TIME,STATUS) ");				sb.append("select sta.app_id,sta.ad_id,sum(sta.cost) dev_cost,?,?,? from T_STATIC_AD_BYDAY sta," +						"(SELECT app.id,dev.status dev_status from T_APPLICATION app, T_DEVELOPER dev where  app.dev_id=dev.id and dev.status!=-1) t1" +						" where sta.static_date=? and sta.app_id=t1.id and t1.dev_status!=-1 GROUP BY sta.app_id,sta.ad_id having sum(sta.cost)>0");				devIncomeAuditDao.update(						sb.toString(),						new Object[] {DateUtil.formatDate(date) + " 00:00:00",										DateUtil.getDateStringByPattern(date,										DateUtil.PARTTERN_DATE_TIME),								0,DateUtil.formatDate(date)});			}		}	}	/**	 * (non-Javadoc)	 * <p>	 * Title: tranceDevEffect	 * </p>	 * <p>	 * Description:TODO	 * </p>	 * 	 * @param start	 * @param end	 * @throws Exception	 * @see cn.adwalker.ad.admin.task.service.IDevIncomeTaskService#tranceDevEffect(java.util.Date,	 *      java.util.Date)	 */	@SuppressWarnings("unchecked")	@Override	public boolean tranceDevEffect(Date date) throws Exception {		System.out.println(DateUtil.formatDate(date));		boolean b = false;		List<EffectVo> list = devIncomeAuditDao				.findTop(						"SELECT t.id,app.os,(select sum((case when app.os = 'ios' then (case type_id when 0 then activate when 1 then click  when 2 then click when 4 then click when 5 then pv end) when app.os = 'android' then (case type_id when 0 then  ACTIVATE when 1 then download when 2 then download when 4 then click when 5 then pv end)end)) effect from T_STATIC_AD_BYDAY where static_date=date_format(t.effect_time, '%Y-%m-%d') and app_id = t.app_id and ad_id = t.ad_id)effect from T_FINACE_DEV_INCOM_CONFIRM t left join t_application app on t.app_id = app.id where EFFECT_TIME >=str_to_date(?, '%Y-%m-%d %T') and EFFECT_TIME <=str_to_date(?, '%Y-%m-%d %T') and EFFECT_NUM is null",						new Object[] { DateUtil.formatDate(date) + " 00:00;00",								DateUtil.formatDate(date) + " 23:59;59" },						EffectVo.class, 5);		if (list != null && list.size() > 2) {			System.out.println(list.size());			List<Object[]> prarms = new ArrayList<Object[]>();			for (EffectVo vo : list) {				System.out.println(vo.getId() + "-----" + vo.getEffect());				prarms.add(new Object[] {						vo.getEffect() != null ? vo.getEffect() : 0, vo.getId() });			}			devIncomeAuditDao					.batchUpdate(							"update T_FINACE_DEV_INCOM_CONFIRM set EFFECT_NUM=? where id=? ",							prarms);		} else {			b = true;		}		return b;	}}